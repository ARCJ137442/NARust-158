//! NARustæ–¹è¨€è¯­æ³•
//! * ğŸ¯æ›´å¹³è¡¡ã€Œç®€å•ã€ã€Œæ˜“è¯»ã€ã€Œæ˜“è§£æã€çš„ç‰¹æ€§

/// ç©ºç™½ç¬¦ | æ‰€æœ‰Unicodeç©ºç™½ç¬¦ï¼Œè§£æå‰å¿½ç•¥
WHITESPACE = _{ WHITE_SPACE }

// åç§° / ç¬¦å· //

/// æ‹¬å¼§
/// * ğŸš©ã€2024-05-15 00:05:12ã€‘åªæ¥å—å°æ‹¬å·
braces = {
    "("
  | ")" // | "[" | "]" | "{" | "}" | "<" | ">"
}

/// ã€Œåç§°ã€
/// * ğŸ¯ç”¨äºåŸå­è¯é¡¹
name = _{
    name_raw
  | name_normal
}

/// ã€Œåç§°ã€å¸¸è§„å½¢å¼
name_normal = @{ !symbol_esc ~ name_head_char ~ (name_body_char)* }

/// ã€Œåç§°ã€å¤´éƒ¨
name_head_char = { LETTER | NUMBER | "_" }

/// ã€Œåç§°ã€ä¸»å¹²
/// * ğŸš©ç‰¹æ®Šï¼šé‡åˆ°ã€Œæ‹¬å¼§ã€æ—¶ä¸­æ–­
name_body_char = { name_head_char | "-" }

/// ã€Œåç§°ã€çº¯å­—ä¸²ï¼ˆä¸åŒ…æ‹¬è½¬ä¹‰ï¼‰
name_raw = _{
    name_esc ~ name_raw_value ~ name_esc
}

/// ã€Œåç§°ã€çº¯å­—ç¬¦ä¸²å€¼
/// * ğŸ¯æ•è·å­—ç¬¦ä¸²å€¼ï¼Œå»æ‰å·¦å³è½¬ä¹‰å·
name_raw_value = @{ (!name_esc ~ ANY)+ }

/// ã€Œåç§°ã€è½¬ä¹‰
/// * ğŸš©å•å¼•å·
name_esc = _{ "'" }

/// ã€Œç¬¦å·ã€
/// * ğŸ¯åŸå­è¯é¡¹å‰ç¼€ã€å¤åˆè¯é¡¹è¿æ¥è¯ã€é™ˆè¿°ç³»è¯
symbol = _{
    symbol_raw
  | symbol_normal
}

/// ã€Œç¬¦å·ã€å¸¸è§„å½¢å¼
symbol_normal = @{ !name_esc ~ symbol_head_char ~ (symbol_body_char)* }

/// ã€Œç¬¦å·ã€å¤´éƒ¨
symbol_head_char = { PUNCTUATION | SYMBOL }

/// ã€Œç¬¦å·ã€ä¸»å¹²
/// * ğŸš©ç‰¹æ®Šï¼šé‡åˆ°ã€Œæ‹¬å¼§ã€ä¸ã€Œåç§°å¤´éƒ¨ã€æ—¶ä¸­æ–­
symbol_body_char = { !WHITE_SPACE ~ !braces ~ !name_head_char ~ !name_esc ~ ANY }

/// ã€Œç¬¦å·ã€çº¯å­—ä¸²ï¼ˆä¸åŒ…æ‹¬è½¬ä¹‰ï¼‰
symbol_raw = _{
    symbol_esc ~ symbol_raw_value ~ symbol_esc
}

/// ã€Œç¬¦å·ã€çº¯å­—ç¬¦ä¸²å€¼
/// * ğŸ¯æ•è·å­—ç¬¦ä¸²å€¼ï¼Œå»æ‰å·¦å³è½¬ä¹‰å·
symbol_raw_value = @{ (!symbol_esc ~ ANY)+ }

/// ã€Œç¬¦å·ã€è½¬ä¹‰
/// * ğŸš©åå¼•å·
symbol_esc = _{ "`" }

// è¯é¡¹ï¼šåŸå­+å¤åˆ //

/// æ€»å…¥å£/è¯é¡¹ï¼šåŸå­+å¤åˆ
/// * ğŸ“Œé™ˆè¿°ç®—ä½œæ˜¯ä¸€ç§ã€Œç‰¹æ®Šçš„äºŒå…ƒè¯é¡¹ã€
term = _{
    compound
  | atom
}

/// åŸå­è¯é¡¹ï¼šå¯é€‰å¸¦å‰ç¼€çš„ã€Œåç§°ã€
atom = ${
    // âŒã€2024-05-14 23:56:45ã€‘ä¸èƒ½ç®€å¹¶ï¼šä¼šé‡åˆ°`\(a _ b)`é—®é¢˜
    name
  | (symbol ~ name)
}

/// å¤åˆè¯é¡¹ï¼šä¸‰ç§å½¢å¼
/// * ğŸ“„ä¸€å…ƒã€äºŒå…ƒã€å¤šå…ƒ
compound = _{
    compound_binary
  | compound_unary
  | compound_multi
}

/// ä¸€å…ƒå¤åˆè¯é¡¹
compound_unary = {
    "(" ~ symbol ~ term ~ ")"
}

/// äºŒå…ƒå¤åˆè¯é¡¹
compound_binary = {
    "(" ~ term ~ symbol ~ term ~ ")"
}

/// å¤šå…ƒå¤åˆè¯é¡¹
compound_multi = {
    symbol ~ "(" ~ (term)+ ~ ")"
}

// è¯­å¥ï¼šè¯é¡¹+æ ‡ç‚¹+æ—¶é—´æˆ³+çœŸå€¼ //

/// ã€ŒçŸ­æµ®ç‚¹ã€
/// * ğŸ¯çœŸå€¼ã€é¢„ç®—å€¼
/// * ğŸš©ç”¨ä½œå†…éƒ¨æ•°å€¼ï¼Œä¸çº¦æŸå–å€¼èŒƒå›´
short_float = @{ (ASCII_DIGIT | ".")+ }

/// æ€»å…¥å£/è¯­å¥ï¼šã€Œè¯é¡¹ã€+ã€Œæ ‡ç‚¹ã€+ã€Œæ—¶é—´æˆ³ã€+ã€ŒçœŸå€¼ã€
/// * ğŸ“Œã€Œæ—¶é—´æˆ³ã€å’Œã€ŒçœŸå€¼ã€æ˜¯å¯é€‰çš„
sentence = {
    term ~ punctuation ~ stamp? ~ truth?
}

/// æ ‡ç‚¹
punctuation = @{ symbol }

/// æ—¶é—´æˆ³ | ç©ºæ—¶é—´æˆ³ä¼šç›´æ¥åœ¨ã€Œè¯­å¥ã€ä¸­ç¼ºçœ
stamp = @{
    ":" ~ (!":" ~ ANY)+ ~ ":"
}

/// çœŸå€¼ | ç©ºçœŸå€¼ä¼šç›´æ¥åœ¨ã€Œè¯­å¥ã€ä¸­ç¼ºçœ
truth = {
    "%" ~ (short_float ~ (";" ~ short_float)* ~ ";"*) ~ "%"
}

// ä»»åŠ¡ï¼šé¢„ç®—å€¼+è¯­å¥ //

/// ä»»åŠ¡ï¼šæœ‰é¢„ç®—çš„è¯­å¥
task = {
    budget ~ sentence
}

/// é¢„ç®—å€¼ | ä¸åŒ…æ‹¬ã€Œç©ºå­—ä¸²ã€éšå«çš„ã€Œç©ºé¢„ç®—ã€
budget = {
    // å¯ç©º
    "$" ~ (short_float ~ (";" ~ short_float)* ~ ";"*)? ~ "$"
}

// Narseseï¼šè¯é¡¹|è¯­å¥|ä»»åŠ¡ //
narsese = _{
    task
  | sentence
  | term
}
